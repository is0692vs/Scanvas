# AGENT.md — AI エージェント運用指針（日本語）

目的

- 本ドキュメントは、リポジトリ内で活動する人間開発者および自動化エージェント（GitHub Copilot / ChatOps エージェント / CI）のための行動ルールとワークフローを定義します。

エージェントの役割

- 人間開発者の補助: コード補完、コード生成、テスト作成、ドキュメント整備、PR 下書き作成。
- 自動化エージェント: 定型タスク（フォーマット、型チェック、CI 実行、依存性更新）の実行。重大な設計変更やセキュリティ関連の変更は人間の承認を必要とする。

基本ルール

1. ブランチとコミット

   - ブランチ命名: issue 番号/type-short-desc（例: "1-chore-project-foundation"）
   - コミットメッセージ: Conventional Commits に準拠（例: `feat(backend): add usb scanner`）

2. PR 作成

   - すべての実装は PR を通してマージする。直接 main へのコミットは禁止。
   - PR の説明には目的・変更点・動作確認手順・テスト結果を記載する。関連 Issue を必ず参照する。

3. テストと品質保証

   - 新規機能には単体テストを追加する。Python は pytest、フロントエンドは Jest（ある場合）を使用。
   - Lint とフォーマッタをパスすること。Python: pylint/flake8 + black 相当、JS: ESLint + Prettier。

4. セキュリティと秘密情報

   - API キーやシークレットをリポジトリに直接書き込まない。プレースホルダと .env を使う。
   - 変更が鍵管理・権限に関わる場合は必ず人間のレビューを要求する。

5. 依存性変更

   - 依存性の追加・更新は最小限にし、理由と影響範囲を PR に記載する。

動作方針（エージェント向け）

- 小さな単位で変更を行う。大きな設計変更は提案書（Issue / ADR）を作成し、人間の合意を得る。

- 変更時は必ずテストを追加または更新し、ローカルでテストを通す手順を PR に記載する。

- 生成したコードに対して自己レビューを実施し、README やドキュメントが不足している場合は補足する。

- 不明点や設計上の選択肢がある場合は必ず確認の Issue を作成して人間に投げる。

PR テンプレートのチェックリスト（エージェントが利用）

- [ ] Issue を参照している
- [ ] ブランチ命名規則に従っている
- [ ] コミットメッセージが Conventional Commits に従っている
- [ ] テストが追加/更新されている（該当する場合）
- [ ] Lint/フォーマットをパスしている
- [ ] セキュリティ/シークレットを含んでいない

開発環境（エージェントが参照可能な起動手順）

1. devcontainer を使う: .devcontainer/devcontainer.json を参照

2. コンテナ内で依存をインストールする: backend: `python -m venv .venv && . .venv/bin/activate && pip install -r requirements.txt`、frontend: `npm install`

3. テスト実行: backend: `pytest`、frontend（ある場合）: `npm test`

運用例ワークフロー

1. Issue が作成される。

2. エージェントが作業計画（小分けされたタスク）を Issue コメントで提案する。

3. 承認後、エージェントは新しいブランチを作成し、修正を行い、テストを追加して PR を作成する。

4. 人間のレビュワーがコードを確認し、必要なら修正依頼を出す。

5. レビュー完了後、PR をマージ（Squash or Merge をチーム合意で選択）する。

作業完了レポート（必須）

エージェントは作業完了時に、必ず日本語で以下の情報を出力し、PR 本文または Issue コメントに貼り付けること。

- 作業まとめ: 実施した変更点を箇条書きで記載（追加/変更/削除したファイルや主要な関数名を含める）
- テスト方法: 存在する場合はテストの実行手順と期待される結果を記載する（コマンド例を含める）
- 影響範囲: 変更が影響するモジュールやコンポーネントを簡潔に説明する
- 次のアクション: 人間が行うべき追加作業や注意点があれば記載する

例:

作業まとめ:

- 追加: `backend/system_info.py`（psutil を使用してシステム情報を取得するユーティリティを追加）
- 追加: `tests/test_system_info.py`（pytest で単体テストを追加）

テスト方法:

1. `python -m venv .venv && . .venv/bin/activate`
2. `pip install -r backend/requirements.txt`
3. `pytest backend/tests/test_system_info.py`

期待結果: すべてのテストが成功すること

禁止事項 / セーフガード

- 機密情報（API キー・トークン・パスワード等）のコミット禁止。

- 本番環境の設定やインフラ（プロダクション）の認証情報を変更する作業は人間の承認必須。

- 破壊的な DB マイグレーションや大規模なアップグレードは ADR を作成して議論する。

連絡方法

- 疑問点は Issue コメントまたは Slack（設定されている場合）で通知すること。

付録

- ブランチ戦略: Git Flow を採用（main, develop, feature/_, release/_, hotfix/\*）

- コードスタイル: Python は PEP8 + type hints を推奨。フロントエンドは ESLint/Prettier を使用。

---

最小限の裁量で安全に自動化を進めるための指針をまとめました。必要なら CI 用ワークフローや PR テンプレートも追加します。
